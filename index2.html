<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>D2 大夜班跨加報名</title>
<style>
  :root{
    --fg:#0f172a; --bg:#f8fafc; --card:#ffffff; --line:#e5e7eb;
    --muted:#6b7280; --brand:#2563eb; --ok:#16a34a; --bad:#dc2626;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",Arial,sans-serif;overscroll-behavior:none}
  .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr}
  header{padding:10px 12px;border-bottom:1px solid var(--line);text-align:center}
  h1{margin:0;font-size:18px;font-weight:700}
  main{display:flex;justify-content:center;align-items:flex-start;padding:10px}
  .panel{width:min(560px,96vw);background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,.04)}
  .grid{display:grid;gap:10px}
  .mmdd{justify-self:center;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700;background:#f1f5f9}
  .input{display:flex;justify-content:center}
  .in{width:240px;height:44px;border:1px solid var(--line);border-radius:10px;text-align:center;font-size:18px;text-transform:uppercase;background:#fff}
  .gtitle{font-size:12px;color:var(--muted);margin-top:4px}
  .row{display:grid;gap:8px}
  .btnrow{display:grid;gap:8px}
  .btnrow.two{grid-template-columns:repeat(2,1fr)}
  .btnrow.three{grid-template-columns:repeat(3,1fr)}
  .btn{height:42px;border:1px solid var(--line);border-radius:10px;background:#f8fafc}
  .btn.sel{outline:2px solid var(--brand);background:#eef2ff}
  .primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .primary:disabled{opacity:.5}
  /* 草稿B */
  .draftB{
    width:100%;
    max-width:640px;
    margin:10px auto 0;
    background:rgba(15,23,42,.8);
    border-radius:12px;
    padding:8px 6px;
    text-align:center;
    border:none;
    box-shadow:none;
  }

  .line{padding:6px 8px;border-bottom:1px dashed #e5e7eb;font-size:13px}
  .line:last-child{border-bottom:0}
  .ok{color:var(--ok)} .ng{color:var(--bad)}
  /* 狀態與時鐘 */
  .statusbar{position:fixed;left:10px;bottom:10px;display:flex;gap:10px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:10px;padding:6px 8px}
  .sitem{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%;background:#cbd5e1;border:1px solid #94a3b8}
  .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
  .clock{position:fixed;right:10px;bottom:10px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>D2 大夜班跨加報名</h1></header>

  <main>
    <section class="panel">
      <div class="grid">
        <div class="input">
          <input id="code" class="in" placeholder="輸入 5 碼" maxlength="5" autocomplete="off" inputmode="latin">
        </div>
        <div id="mmdd" class="mmdd">--/--</div>

        <div class="row">
          <div class="gtitle">A 選擇</div>
          <div class="btnrow two">
            <button class="btn" data-a="1">A1</button>
            <button class="btn" data-a="2">A2</button>
          </div>
        </div>

        <div class="row">
          <div class="gtitle">B 選擇</div>
          <div class="btnrow three">
            <button class="btn" data-b="上">上</button>
            <button class="btn" data-b="中">中</button>
            <button class="btn" data-b="下">下</button>
          </div>
        </div>

        <button id="sendBtn" class="btn primary" disabled>送出</button>
      </div>
    </section>
    <!-- 草稿B區塊放這裡，緊貼主體 -->
    <div class="draftB" id="draftBoxB"><div id="draftB"></div></div>
  </main>
</div>

<!-- 左下三燈（GET） -->
<div class="statusbar">
  <div class="sitem"><span class="dot" id="dotGas"></span>GAS連線</div>
  <div class="sitem"><span class="dot" id="dotSs"></span>試算表</div>
  <div class="sitem"><span class="dot" id="dotSh"></span><span id="shLabel">試算表名</span></div>
</div>
<!-- 右下時鐘：mm/dd HH:mm:ss -->
<div class="clock" id="clock">--/-- --:--:--</div>

<script>
/* ===== 常量 ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';
const TZ = 'Asia/Taipei';
let selA = '2';    // 預設
let selB = '中';

/* ===== 工具：時間 ===== */
function mmddRule(){
  const now = new Date();
  const h = parseInt(new Intl.DateTimeFormat('zh-Hant-TW',{timeZone:TZ,hour:'2-digit',hour12:false}).format(now),10);
  const base = new Date(now);
  if(h >= 1) base.setDate(base.getDate()+1);
  const p = new Intl.DateTimeFormat('zh-Hant-TW',{timeZone:TZ,month:'2-digit',day:'2-digit'})
            .formatToParts(base).reduce((a,b)=>(a[b.type]=b.value,a),{});
  return `${p.month}/${p.day}`;
}
function updateMmdd(){ document.getElementById('mmdd').textContent = mmddRule(); }
function startClock(){
  const el = document.getElementById('clock');
  const tick = ()=>{
    const d = new Date();
    const md = new Intl.DateTimeFormat('zh-Hant-TW',{timeZone:TZ,month:'2-digit',day:'2-digit'}).formatToParts(d)
               .reduce((a,b)=>(a[b.type]=b.value,a),{});
    const t  = new Intl.DateTimeFormat('zh-Hant-TW',{timeZone:TZ,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).formatToParts(d)
               .reduce((a,b)=>(a[b.type]=b.value,a),{});
    el.textContent = `${md.month}/${md.day} ${t.hour}:${t.minute}:${t.second}`; // mm/dd HH:mm:ss
  };
  tick(); setInterval(tick, 1000);
}
function tsMin(){
  const t = new Intl.DateTimeFormat('zh-Hant-TW',{timeZone:TZ,month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false})
            .formatToParts(new Date()).reduce((a,b)=>(a[b.type]=b.value,a),{});
  return `${t.month}/${t.day} ${t.hour}:${t.minute}`;
}

/* ===== 高亮與送出權限 ===== */
function setSel(btns,val,attr){
  btns.forEach(b=>{
    const on = b.dataset[attr]===val;
    b.classList.toggle('sel', on);
    b.setAttribute('aria-pressed', on?'true':'false');
  });
}
function enableSend(){ document.getElementById('sendBtn').disabled = !(selA && selB); }

/* ===== 草稿B：最多10筆 ===== */
const DRAFTB_KEY='d2_draft_b_v1';
function loadB(){ try{ return JSON.parse(localStorage.getItem(DRAFTB_KEY)||'[]'); }catch(_){ return []; } }
function saveB(a){ localStorage.setItem(DRAFTB_KEY, JSON.stringify(a.slice(-10))); }
function renderB(){
  const box = document.getElementById('draftBoxB');
  const list= document.getElementById('draftB');
  const arr = loadB();
  if(!arr.length){ box.style.display='none'; list.innerHTML=''; return; }
  box.style.display='block';
  list.innerHTML = arr.map(x=>`<div class="line ${x.ok?'ok':'ng'}">${x.ts} | ${x.id} | ${x.ok?'ok':'ng'}</div>`).join('');
}
function addB(ok,id){ const a=loadB(); a.push({ts:tsMin(), id, ok}); saveB(a); renderB(); }

/* ===== 連線燈（GET） ===== */
async function probeStatus(){
  const gas=document.getElementById('dotGas');
  const ss =document.getElementById('dotSs');
  const sh =document.getElementById('dotSh');
  const lab=document.getElementById('shLabel');
  const cls=(el,c)=>{el.classList.remove('ok','bad'); el.classList.add(c);};
  try{
    const r = await fetch(API_URL+'?target=1',{method:'GET',cache:'no-store'});
    cls(gas, r.ok?'ok':'bad');
    const j = await r.json().catch(()=>null);
    if(j && j.fileExists) cls(ss,'ok');
    if(j && j.sheetExists){ cls(sh,'ok'); lab.textContent='sh1'; }
  }catch(_){ cls(gas,'bad'); }
}

/* ===== 傳送（URLSearchParams, x-www-form-urlencoded） ===== */
function submitData(p){
  const params = new URLSearchParams();
  params.append('action','submit');
  params.append('key',  p.key);
  params.append('date', p.date);
  params.append('shift',p.shift);
  params.append('id',   p.id);
  params.append('dN',   p.dN);
  return fetch(API_URL,{method:'POST',body:params,cache:'no-store'})
    .then(r=>r.text())
    .then(t=>{try{return JSON.parse(t);}catch(_){return {status:'parse_failed',raw:t};}});
}

/* ===== 事件 ===== */
function bindInput(){
  const el=document.getElementById('code');
  el.addEventListener('input',()=>{ let x=el.value.replace(/[^A-Za-z0-9]/g,'').slice(0,5); el.value=x.toUpperCase(); });
  el.addEventListener('focus',()=>{ if(el.value) el.value=''; });
}
async function send(){
  const id=document.getElementById('code').value.trim().toUpperCase();
  if(!/^[A-Z0-9]{5}$/.test(id)) return;
  const md = mmddRule();            // "MM/DD"
  const date = md.replace('/','');  // "MMDD"
  const payload = { id, date, key:`${date}|${id}`, shift: selB, dN: selA };
  let ok=false, res;
  try{ res=await submitData(payload); ok = res && res.status==='ok'; }catch(_){ ok=false; }
  addB(ok,id);
}

/* ===== 啟動 ===== */
addEventListener('DOMContentLoaded',()=>{
  // 預設 A=2, B=中
  setSel(document.querySelectorAll('[data-a]'), selA, 'a');
  setSel(document.querySelectorAll('[data-b]'), selB, 'b');
  document.querySelectorAll('[data-a]').forEach(b=> b.addEventListener('click', ()=>{ selA=b.dataset.a; setSel(document.querySelectorAll('[data-a]'), selA,'a'); enableSend(); }));
  document.querySelectorAll('[data-b]').forEach(b=> b.addEventListener('click', ()=>{ selB=b.dataset.b; setSel(document.querySelectorAll('[data-b]'), selB,'b'); enableSend(); }));
  bindInput(); enableSend(); updateMmdd(); setInterval(updateMmdd,60*1000);
  startClock(); probeStatus(); renderB();
  document.getElementById('sendBtn').addEventListener('click', send);
});
</script>
</body>
</html>