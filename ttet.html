<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>音檔載入與快取測試3</title>
<style>
body{background:#111;color:#e5e7eb;font-family:system-ui,monospace;padding:20px;}
h2{color:#0ff;}
.ok{color:#00ff9d;}
.err{color:#ff5c5c;}
.box{margin-bottom:24px;}
button{padding:10px 16px;border:0;border-radius:6px;background:#0ff;color:#000;cursor:pointer;}
</style>
</head>
<body>
<h2>音檔載入與快取測試</h2>
<button id="startBtn">開始測試</button>
<div id="direct" class="box"><h3>直接載入測試</h3></div>
<div id="cache" class="box"><h3>快取讀取測試</h3></div>

<script>
const BASE = '/ut5_M14_D2C01/mus/';
const MUS_FILES = [
  BASE + 'Detektiv.mp3',
  BASE + 'Prontera.mp3',
  BASE + 'login1.mp3',
  BASE + 'login2.wav',
  BASE + 'login3.mp3',
  BASE + 'clock01.mp3',
  BASE + 'clock02.wav',
  BASE + 'levelup.wav'
];
const boxDirect = document.getElementById('direct');
const boxCache  = document.getElementById('cache');

function log(el, ok, msg){
  const div = document.createElement('div');
  div.className = ok ? 'ok' : 'err';
  div.textContent = (ok?'✅ ':'❌ ') + msg;
  el.appendChild(div);
}

function testDirect(){
  MUS_FILES.forEach(src=>{
    const a = new Audio(src+'?v='+Date.now());
    a.play().then(()=>{
      a.pause(); log(boxDirect,true,'直接載入成功：'+src);
    }).catch(e=>{
      log(boxDirect,false,'直接載入失敗：'+src+' ('+e.message+')');
    });
  });
}

async function testCache(){
  if(!('caches' in window)){ log(boxCache,false,'瀏覽器不支援 Cache API'); return; }
  const cacheName='mus-test-v1';
  const c=await caches.open(cacheName);
  await c.addAll(MUS_FILES).catch(e=>log(boxCache,false,'快取建立失敗 ('+e.message+')'));
  for(const src of MUS_FILES){
    const r=await c.match(src);
    if(!r){ log(boxCache,false,'快取找不到：'+src); continue; }
    try{
      const blob=await r.blob();
      const a=new Audio(URL.createObjectURL(blob));
      await a.play(); a.pause();
      log(boxCache,true,'快取播放成功：'+src);
    }catch(e){
      log(boxCache,false,'快取播放失敗：'+src+' ('+e.message+')');
    }
  }
}

document.getElementById('startBtn').addEventListener('click', async()=>{
  document.getElementById('startBtn').disabled = true;
  testDirect();
  await testCache();
});
</script>
</body>
</html>