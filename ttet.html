<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>音檔載入與快取測試2</title>
<style>
body{background:#111;color:#e5e7eb;font-family:system-ui,monospace;padding:20px;}
h2{color:#0ff;}
.ok{color:#00ff9d;}
.err{color:#ff5c5c;}
.box{margin-bottom:24px;}
</style>
</head>
<body>
<h2>音檔載入與快取測試</h2>
<div id="direct" class="box"><h3>直接載入測試</h3></div>
<div id="cache" class="box"><h3>快取讀取測試</h3></div>

<script>
const BASE = '/ut5_M14_D2C01/mus/';
const MUS_FILES = [
  BASE + 'Detektiv.mp3',
  BASE + 'Prontera.mp3',
  BASE + 'login1.mp3',
  BASE + 'login2.wav',
  BASE + 'login3.mp3',
  BASE + 'clock01.mp3',
  BASE + 'clock02.wav',
  BASE + 'levelup.wav'
];

const boxDirect = document.getElementById('direct');
const boxCache  = document.getElementById('cache');

function testDirect() {
  MUS_FILES.forEach(src => {
    const audio = new Audio(src + '?v=' + Date.now());
    audio.play().then(() => {
      audio.pause();
      const ok = document.createElement('div');
      ok.className = 'ok';
      ok.textContent = '✅ 直接載入成功：' + src;
      boxDirect.appendChild(ok);
    }).catch(err => {
      const line = document.createElement('div');
      line.className = 'err';
      line.textContent = '❌ 直接載入失敗：' + src + ' (' + err.message + ')';
      boxDirect.appendChild(line);
    });
  });
}

async function testCache() {
  if (!('caches' in window)) {
    boxCache.innerHTML += '<div class="err">瀏覽器不支援 Cache API</div>';
    return;
  }

  const cacheName = 'mus-test-v1';
  const c = await caches.open(cacheName);
  await c.addAll(MUS_FILES).catch(e => {
    const msg = document.createElement('div');
    msg.className = 'err';
    msg.textContent = '❌ 快取建立失敗 (' + e.message + ')';
    boxCache.appendChild(msg);
  });

  for (const src of MUS_FILES) {
    const r = await c.match(src);
    if (!r) {
      const miss = document.createElement('div');
      miss.className = 'err';
      miss.textContent = '❌ 快取找不到：' + src;
      boxCache.appendChild(miss);
      continue;
    }
    try {
      const blob = await r.blob();
      const audio = new Audio(URL.createObjectURL(blob));
      await audio.play();
      audio.pause();
      const ok = document.createElement('div');
      ok.className = 'ok';
      ok.textContent = '✅ 快取播放成功：' + src;
      boxCache.appendChild(ok);
    } catch (e) {
      const errLine = document.createElement('div');
      errLine.className = 'err';
      errLine.textContent = '❌ 快取播放失敗：' + src + ' (' + e.message + ')';
      boxCache.appendChild(errLine);
    }
  }
}

(async () => {
  testDirect();
  await testCache();
})();
</script>
</body>
</html>