<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>資料庫管理 · 行政灰</title>
<style>
  :root { --font:16px; --wrap:90vw; }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;font-size:var(--font);background:#eef1f5;color:#1f2937;line-height:1.4;}
  *{box-sizing:border-box;}

  .page{min-height:100%;display:flex;flex-direction:column;}

  /* 頂部工具列 */
  header{height:52px;background:#fff;border-bottom:1px solid #d1d5db;display:flex;align-items:center;justify-content:space-between;padding:0 14px;}
  .status{display:flex;gap:10px;align-items:center;}
  .badge{padding:2px 10px;border:1px solid #9ca3af;border-radius:999px;color:#374151;background:#f9fafb}
  .badge.ok{border-color:#059669;color:#065f46;background:#ecfdf5}
  .badge.err{border-color:#dc2626;color:#7f1d1d;background:#fef2f2}
  .clock{font-variant-numeric:tabular-nums;color:#374151;}

  /* 包裹寬度：非百分比分欄，容器寬可隨視窗變化 */
  .wrap{width:min(var(--wrap), 960px);margin:12px auto;display:flex;flex-direction:column;gap:12px;}

  /* 面板：行政灰，線條分隔，無陰影 */
  .panel{background:#fff;border:1px solid #d1d5db;border-radius:8px;}
  .panel-head{padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;}
  .panel-title{font-weight:600;color:#111827;}
  .panel-body{padding:0 0 10px 0;}

  /* 表格面板 */
  .tbl-wrap{max-height:calc(100vh - 220px);overflow-y:auto;overflow-x:hidden;} /* 僅縱向需要時捲動，禁止橫向 */
  table{width:100%;border-collapse:collapse;table-layout:fixed;}
  thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid #e5e7eb;padding:8px 6px;color:#374151;}
  tbody td{border-bottom:1px solid #f3f4f6;padding:8px 6px;text-align:center;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  tbody tr:hover{background:#f9fafb;cursor:pointer;}

  th.col-id,   td.col-id   { width:5ch; }
  th.col-name, td.col-name { width:5em; }
  th.col-tier, td.col-tier { width:5ch; }
  th.col-date, td.col-date { width:11ch; }

  /* 名字欄截斷 */
  .truncate5{display:inline-block;max-width:5em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

  /* 表單面板：2×3（兩行三格） */
  .form-body{padding:10px 12px;display:flex;flex-direction:column;gap:8px;}
  .row{display:flex;gap:8px;align-items:end;}
  .cell{display:flex;flex-direction:column;gap:4px;min-width:0;max-width:100%;}
  label{font-size:.92em;color:#4b5563;}
  /* 固定輸入寬（非%） */
  .cell.id    { flex:0 0 10ch; }
  .cell.name  { flex:1 1 auto; }
  .cell.blank { flex:1 1 06ch; }
  .cell.tier  { flex:0 0 6ch; }
  .cell.limit { flex:0 0 8ch; }
  .cell.submit{ flex:0 0 auto; display:flex; justify-content:flex-end; }
  /* 控件 */
  .ctl{width:100%;padding:9px 10px;font-size:1em;border:1px solid #cbd5e1;border-radius:8px;background:#fff;color:#111827;}
  .btn{padding:9px 14px;font-size:1em;border-radius:8px;border:1px solid #9ca3af;background:#f3f4f6;color:#111827;cursor:pointer;}
  .btn.primary{border-color:#2563eb;background:#2563eb;color:#fff;}
  .btn:active{transform:translateY(1px);}

  /* 遮罩 */
  #mask{position:fixed;inset:0;background:rgba(31,41,55,.15);display:none;align-items:center;justify-content:center;z-index:999;}
  .spinner{width:42px;height:42px;border:4px solid #e5e7eb;border-top:4px solid #374151;border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<header>
  <div class="status">
    <span>GAS 狀態：</span><span id="gasBadge" class="badge">--</span>
  </div>
  <div id="clock" class="clock">--:--:--</div>
</header>

<main class="wrap">
  <!-- 表格面板 -->
  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">資料庫列表</div>
      <button id="btnReload" class="btn">更新</button>
    </div>
    <div class="panel-body">
      <div class="tbl-wrap" id="tblWrap">
        <table>
          <thead>
            <tr>
              <th class="col-id">ID</th>
              <th class="col-name">名字</th>
              <th class="col-tier">級距</th>
              <th class="col-date">日期</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 表單面板 -->
  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">新增 / 更新</div>
      <div style="opacity:.6;font-size:.9em;">單筆上傳，累積 10 筆自動刷新</div>
    </div>
    <div class="panel-body form-body">
      <!-- 第1行：ID | 名字 | 空白 -->
      <div class="row">
        <div class="cell id">
          <input id="id" class="ctl" maxlength="5" autocomplete="off" />
        </div>
        <div class="cell name">
          <input id="name" class="ctl" autocomplete="off" />
        </div>
        <div class="cell blank"></div>
      </div>
      <!-- 第2行：級距 | limit | 上傳 -->
      <div class="row">
        <div class="cell tier">
          <select id="tier" class="ctl">
            <option>0</option><option>1</option><option>2</option>
            <option selected>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="cell limit">
          <input id="limit" class="ctl" inputmode="numeric" />
        </div>
        <div class="cell submit">
          <label for="btnUpload">　</label>
          <button id="btnUpload" class="btn primary">上傳</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- 遮罩 -->
<div id="mask"><div class="spinner"></div></div>

<script>
/* 固定端點 */
const API_URL='https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';

/* DOM */
const rows = document.getElementById('rows');
const mask = document.getElementById('mask');
const gasBadge = document.getElementById('gasBadge');
const clockEl = document.getElementById('clock');

const idE = document.getElementById('id');
const nameE = document.getElementById('name');
const tierE = document.getElementById('tier');
const limitE = document.getElementById('limit');

const rowById = Object.create(null);
let uploadCount = 0;

/* 時鐘（台北） */
let nowTPE = new Date();
function z(n){return String(n).padStart(2,'0');}
function fmtYMD(d){ return d.getUTCFullYear()+'-'+z(d.getUTCMonth()+1)+'-'+z(d.getUTCDate()); }
function fmtYMDHMS(d){ return fmtYMD(d)+' '+z(d.getUTCHours())+':'+z(d.getUTCMinutes())+':'+z(d.getUTCSeconds()); }
function getNowTPE(){
  const f=new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const o=Object.fromEntries(f.formatToParts(new Date()).map(p=>[p.type,p.value]));
  return new Date(Date.UTC(+o.year,+o.month-1,+o.day,+o.hour,+o.minute,+o.second));
}
function tick(){ nowTPE=getNowTPE(); clockEl.textContent=fmtYMDHMS(nowTPE); }
setInterval(tick,1000); tick();

/* Excel/試算表序號工具 */
const EPOCH=Date.UTC(1899,11,30);
function serialToYmd(n){ if(typeof n!=='number' || !isFinite(n)) return ''; const ms=n*86400000+EPOCH; const dt=new Date(ms); return fmtYMD(new Date(Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate()))); }
function baseSerial(d){ return Math.floor((Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-EPOCH)/86400000); }
function viewLimit(raw){ if(raw===0 || raw==='0') return '永久'; return (typeof raw==='number') ? serialToYmd(raw) : (raw || ''); }

/* 遮罩 */
function showMask(){mask.style.display='flex';}
function hideMask(){mask.style.display='none';}

/* GAS ping */
function ping(){
  fetch(API_URL+'?ping=1',{cache:'no-store'})
    .then(r=>{ gasBadge.textContent=r.ok?'OK':'ERR'; gasBadge.className='badge '+(r.ok?'ok':'err'); })
    .catch(()=>{ gasBadge.textContent='ERR'; gasBadge.className='badge err';});
}
ping(); setInterval(ping,45000);

/* 渲染 */
function render(values){
  rows.innerHTML='';
  for(const v of (values||[])){
    const id=v[0], name=v[1], tier=v[2], raw=v[3];
    const ymd=viewLimit(raw);
    const safeName=String(name||'');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="col-id"   title="${id}">${id}</td>
      <td class="col-name" title="${safeName}"><span class="truncate5">${safeName}</span></td>
      <td class="col-tier" title="${tier}">${tier}</td>
      <td class="col-date" title="${ymd}">${ymd}</td>`;
    tr.onclick=()=>fill(id,name,tier);
    rows.appendChild(tr);
    rowById[id]=tr;
  }
}

/* 點列帶入 */
function fill(id,name,tier){
  idE.value=id||''; nameE.value=name||''; tierE.value=String(tier??3); limitE.value='';
  document.querySelector('.panel:last-of-type').scrollIntoView({behavior:'smooth', block:'nearest'});
}

/* 讀取 */
function reload(){
  showMask();
  const p=new URLSearchParams(); p.append('action','list_recent2');
  fetch(API_URL,{method:'POST',body:p})
    .then(r=>r.json())
    .then(d=>{ if(d.status==='ok') render(d.values||[]); })
    .catch(console.error)
    .finally(hideMask);
}

/* 附加或替換至表尾（樂觀更新） */
function appendOrReplaceBottom(p){
  const old=rowById[p.id]; if(old) old.remove();
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td class="col-id"   title="${p.id}">${p.id}</td>
    <td class="col-name" title="${p.name}"><span class="truncate5">${p.name}</span></td>
    <td class="col-tier" title="${p.tier}">${p.tier}</td>
    <td class="col-date" title="${p.ymd||''}">${p.ymd||''}</td>`;
  tr.onclick=()=>fill(p.id,p.name,p.tier);
  rows.appendChild(tr);
  rowById[p.id]=tr;
}

/* limit>0 才換算；空或0 → 傳空字串 */
function computeLimitSerial(limitStr){
  if (limitStr==='' || Number(limitStr)===0) return {serial:'', ymd:''};
  const mins=nowTPE.getUTCHours()*60 + nowTPE.getUTCMinutes();
  const base=new Date(nowTPE);
  if(mins<500) base.setUTCDate(base.getUTCDate()-1);
  const serial=baseSerial(base) + Number(limitStr);
  return {serial:String(serial), ymd:serialToYmd(serial)};
}

/* 上傳 */
function upload(){
  const id=(idE.value||'').trim().toUpperCase();
  const name=(nameE.value||'').trim();
  const tier=parseInt(tierE.value,10);
  const limit=(limitE.value||'').trim();

  if(!/^[A-Z0-9]{5}$/.test(id)) return alert('ID 需為 5 碼英數大寫');
  if(!name) return alert('名字不得為空');
  if(Number.isNaN(tier)||tier<0||tier>5) return alert('級距需 0–5');
  if(limit!=='' && !/^[0-9]+$/.test(limit)) return alert('limit 僅允許純數字');

  const {serial, ymd}=computeLimitSerial(limit);

  showMask();
  const form=new URLSearchParams();
  form.append('action','upsert');
  form.append('id',id);
  form.append('name',name);
  form.append('tier',String(tier));
  form.append('limit_date',serial); // '' 或 數字字串

  fetch(API_URL,{method:'POST',body:form})
    .then(r=>r.json())
    .then(res=>{
      if(res.status==='ok'){
        appendOrReplaceBottom({id,name,tier,ymd});
        if(++uploadCount>=10){ uploadCount=0; reload(); }
        idE.value=''; nameE.value=''; tierE.value='3'; limitE.value='';
      }else{
        alert(res.msg||'上傳失敗');
      }
    })
    .catch(e=>{ console.error(e); alert('上傳錯誤'); })
    .finally(hideMask);
}

/* 聚焦滾入可視區，避免鍵盤遮住 */
document.addEventListener('focusin', e=>{
  if(e.target.classList && e.target.classList.contains('ctl')){
    e.target.scrollIntoView({behavior:'smooth', block:'center'});
  }
}, true);

/* 輸入規則 */
idE.oninput=()=>{ idE.value=idE.value.toUpperCase().replace(/[^A-Z0-9]/g,''); };
limitE.oninput=()=>{ limitE.value=limitE.value.replace(/[^\d]/g,''); };

/* 綁定 */
document.getElementById('btnReload').onclick=reload;
document.getElementById('btnUpload').onclick=upload;

/* 初始讀取 */
reload();
</script>
</body>
</html>