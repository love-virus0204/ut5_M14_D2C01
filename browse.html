<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>D2名單瀏覽</title>
<style>
:root{--bg:#0b1220;--panel:#1a2333cc;--text:#e5e7eb;--sub:#94a3b8;--line:#1f2937;--accent:#22d3ee}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,"Microsoft JhengHei",sans-serif}
.container{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:16px}
h1{margin:8px 0 12px;font-size:18px;letter-spacing:.08em;color:var(--accent)}
.wrap{width:min(720px,94vw);background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:10px}
.head{display:grid;grid-template-columns:1fr 1fr;text-align:center;color:var(--sub);margin-bottom:6px}
.row{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px dashed #1f2a44}
.row:last-child{border-bottom:0}
.cell{padding:8px 10px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cell.l{color:#7dd3fc}.cell.r{color:#fcd34d}
.spinner{border:4px solid rgba(255,255,255,.2);border-top:4px solid var(--accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:40px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none}
.footer{margin-top:10px;font-size:12px;color:var(--sub)}
.btn{margin-top:8px;appearance:none;border:0;border-radius:10px;background:linear-gradient(180deg,#0ea5e9,#0369a1);padding:8px 18px;color:#fff;font-weight:700;letter-spacing:.06em;cursor:pointer;transition:transform .12s}
.btn:hover{transform:translateY(-1px)}.btn:active{transform:translateY(1px)}
</style>
</head>
<body>
<div class="container">
  <h1>D2大夜班跨加報名名單</h1>

  <div id="loading" class="spinner"></div>
  <section id="box" class="wrap hidden">
    <div class="head"><div>A 班</div><div>B 班</div></div>
    <div id="rows"></div>
  </section>

  <button class="btn" onclick="loadData(LAST_PAYLOAD)">重新整理</button>
  <div class="footer">更新：<span id="uTime">--/-- --:--</span></div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';
const TZ = 'Asia/Taipei';
let LAST_PAYLOAD = null; // 記住最近一次查詢參數

function pad(n){return String(n).padStart(2,'0')}
function nowStr(){
  const d=new Date(Date.now()+8*60*60*1000);
  return `${pad(d.getUTCMonth()+1)}/${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}`;
}

/* ===== 照抄你的 POST 模式（不預設參數）===== */
async function fetchList(payload){
  const body = new URLSearchParams(payload);          // 僅用 x-www-form-urlencoded
  const r = await fetch(API_URL, { method:'POST', body });
  const txt = await r.text();
  try{ return JSON.parse(txt); } catch(_){ return []; } // 你的後端會直接回陣列
}

/* ===== 渲染：shift=A 左，shift=B 右；列格式 {id,dN | id,dN} ===== */
function render(list){
  const A = list.filter(x=>String(x.shift).toUpperCase()==='A');
  const B = list.filter(x=>String(x.shift).toUpperCase()==='B');
  const max = Math.max(A.length, B.length);
  let html = '';
  for(let i=0;i<max;i++){
    const a = A[i] ? `${A[i].id||''}, ${A[i].dN||''}` : '';
    const b = B[i] ? `${B[i].id||''}, ${B[i].dN||''}` : '';
    html += `<div class="row"><div class="cell l">${a}</div><div class="cell r">${b}</div></div>`;
  }
  if(!max) html = `<div class="row"><div class="cell l">目前無資料</div><div class="cell r"></div></div>`;
  document.getElementById('rows').innerHTML = html;
}

/* ===== 封裝流程：外部傳 payload 進來 ===== */
async function loadData(payload){
  LAST_PAYLOAD = payload; // 記錄本次查詢參數
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('box').classList.add('hidden');

  let data=[];
  try{ data = await fetchList(payload); }catch(_){ data=[]; }

  render(Array.isArray(data)?data:[]);
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('box').classList.remove('hidden');
  document.getElementById('uTime').textContent = nowStr();
}

/* 首次載入時，你自行決定帶什麼參數 */
loadData({ action:'list_recent' }); // ← 與你原專案一致；要改你直接改這行
</script>
</body>
</html>