<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>D2 名單檢視 / 抽籤</title>
<style>
  :root{ --w:90vw; --hbar:60px; --gap:10px; --card:#0b1324; --line:#223; --txt:#cfe9ff; --mut:#8aa4bf; --ok:#10b981; --err:#ef4444; --btn:#1e90ff; }
  *{ box-sizing:border-box }
  html,body{height:100%;margin:0;overflow-x:hidden;background:radial-gradient(1200px 600px at 50% -200px,#0b1a33,#060d1b);color:var(--txt);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
  .page{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:var(--gap);width:100%}

  /* 上區 */
  .bar{position:sticky;top:0;z-index:5;height:var(--hbar);display:flex;align-items:center;justify-content:space-between;width:var(--w);max-width:900px;background:rgba(7,15,30,.8);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:10px;margin-top:10px;padding:0 10px}
  .left,.mid,.right{display:flex;align-items:center;gap:10px}
  .badge{padding:3px 10px;border-radius:999px;font-size:.92em;border:1px solid var(--line);color:var(--mut)}
  .badge.ok{color:var(--ok);border-color:#1d3}
  .badge.err{color:var(--err);border-color:#833}
  .date{font-variant-numeric:tabular-nums}
  .time{opacity:.9}
  .btn{padding:8px 12px;border-radius:10px;background:var(--btn);color:#fff;border:0;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* 下區 */
  .wrap{width:var(--w);max-width:900px;display:flex;flex-direction:column;gap:12px;margin:10px 0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;min-width:0}
  .hdr{display:flex;align-items:center;justify-content:space-between;color:var(--mut);font-size:.95em;margin-bottom:6px}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px;min-width:0}
  .panel{background:rgba(255,255,255,.02);border:1px solid var(--line);border-radius:10px;display:flex;flex-direction:column;min-height:240px;min-width:0}
  .panel h3{margin:0;padding:10px;border-bottom:1px solid var(--line);text-align:center}
  .thead,.row{
    display:grid;
    grid-template-columns:6ch 10ch minmax(0,1fr) 6ch; /* #, ID, 姓名, 假別 */
    gap:6px; padding:8px 12px; align-items:center;
    justify-items:center;
  }
  .thead{color:var(--mut);border-bottom:1px dashed var(--line)}
  .row + .row{border-top:1px dotted #1a2538}
  .row div:nth-child(3), .thead div:nth-child(3){ /* 姓名欄 */
    text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; min-width:0;
  }
  .empty{padding:16px;text-align:center;color:var(--mut)}
  .small{font-size:.85em;color:var(--mut);text-align:center}

/* 防止任何容器在直立螢幕產生橫向卷軸 */
html,body,.wrap,.card,.cols,.panel,.body,.thead,.row{ max-width:100%; overflow-x:hidden }
.thead div,.row div{ min-width:0 }  /* 允許格內縮 */

/* 小螢幕：縮小 #、ID、假別 欄，姓名保留 minmax(0,1fr) */
@media (max-width:420px){
  .thead,.row{
    grid-template-columns: 5ch 8ch minmax(0,1fr) 5ch;
    padding:6px 8px;
  }
}

/* 內容過長一律截斷；ID 如有長字元則允許斷行 */
  .row div:nth-child(2),
  .row div:nth-child(3){ overflow:hidden; text-overflow:ellipsis;white-space:nowrap;}
/* .row div:nth-child(2){ word-break:break-all } */

  /* 遮罩 */
  .mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:10}
  .mask.show{display:flex}
  .toast{min-width:220px;max-width:70vw;background:#0e182b;color:#e6f2ff;border:1px solid #245;border-radius:12px;padding:14px 16px;box-shadow:0 6px 22px rgba(0,0,0,.4);text-align:center}
  .toast.ok{border-color:#1d3}
  .toast.err{border-color:#833}
</style>
</head>
<body>
<div class="page">
  <!-- 上區 -->
  <div class="bar">
    <div class="left">
      <span id="stat" class="badge">狀態: 檢查中</span>
    </div>
    <div class="mid">
      <span id="ymd" class="date">--/--</span>
      <span id="clock" class="time">--:--:--</span>
    </div>
    <div class="right">
      <button id="reload" class="btn">讀數據</button>
      <button id="draw" class="btn">執行抽籤</button>
    </div>
  </div>

  <!-- 下區 -->
  <div class="wrap">
    <div class="card">
      <div class="hdr">
        <div>日期：<span id="hdrDate">--/--</span></div>
        <div class="small">筆數：<span id="count">0</span>（依後端排序顯示）</div>
      </div>
      <div class="cols">
        <div class="panel">
          <h3>A 班</h3>
          <div class="thead"><div>#</div><div>ID</div><div>姓名</div><div>假別</div></div>
          <div id="listA" class="body"><div class="empty">此日期無資料</div></div>
        </div>
        <div class="panel">
          <h3>B 班</h3>
          <div class="thead"><div>#</div><div>ID</div><div>姓名</div><div>假別</div></div>
          <div id="listB" class="body"><div class="empty">此日期無資料</div></div>
        </div>
      </div>
    </div>
    <div class="small">更新：<span id="updated">--/-- --:--</span></div>
  </div>
</div>

<!-- 遮罩 -->
<div id="mask" class="mask"><div id="toast" class="toast">處理中…</div></div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';
const tz='Asia/Taipei';
const fmtYMD=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'});
const fmtMD =new Intl.DateTimeFormat('en-US',{timeZone:tz,month:'2-digit',day:'2-digit'});
const fmtHM =new Intl.DateTimeFormat('en-US',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});

const $ = (q)=>document.querySelector(q);
const el={ stat:$('#stat'), ymd:$('#ymd'), clock:$('#clock'), hdrDate:$('#hdrDate'),
           count:$('#count'), listA:$('#listA'), listB:$('#listB'), updated:$('#updated'),
           mask:$('#mask'), toast:$('#toast'), draw:$('#draw'), reload:$('#reload') };

let lockedYMD='', lockedSerial=0;

function showMask(msg,type){ el.toast.textContent=msg; el.toast.className='toast ' + (type||''); el.mask.classList.add('show'); }
function hideMask(){ el.mask.classList.remove('show') }

function nowTPE(){
  const n=new Date();
  return new Date(n.toLocaleString('en-US',{timeZone:tz}));
}
function lockToday(){
  const d=nowTPE();
  lockedYMD=fmtYMD.format(d); // yyyy-mm-dd
  lockedSerial=toSerialInt(lockedYMD);
  const md=fmtMD.format(d);
  el.ymd.textContent=md;
  el.hdrDate.textContent=md;
}
function toSerialInt(ymd){
  const epoch=Date.UTC(1899,11,30);
  const d=new Date(ymd+'T00:00:00+08:00');
  return Math.floor((d-epoch)/86400000);
}
function tick(){ el.clock.textContent=fmtHM.format(nowTPE()); }

async function ping(){
  try{
    const r=await fetch(API_URL+'?action=ping',{cache:'no-store'});
    if(r.ok){ el.stat.textContent='狀態: OK'; el.stat.className='badge ok'; }
    else{ el.stat.textContent='狀態: ERR'; el.stat.className='badge err'; }
  }catch(e){ el.stat.textContent='狀態: ERR'; el.stat.className='badge err'; }
}

async function readData(){
  showMask('讀取中…');
  try{
    const p=new URLSearchParams(); p.append('action','list_recent2');
    const r=await fetch(API_URL,{method:'POST',body:p});
    const j=await r.json();
    render(j);
    const t=nowTPE();
    el.updated.textContent=fmtMD.format(t)+' '+fmtHM.format(t).slice(0,5);
    hideMask();
  }catch(e){
    showMask('讀取失敗','err');
    setTimeout(hideMask,1200);
  }
}

function render(j){
  const F=(j.fields||[]);
  const idx=(name,def)=>{const k=F.indexOf(name);return k>=0?k:def}
  const iDate=idx('date',2), iId=idx('id',3), iName=idx('name',1), iShift=idx('shift',4), iDN=idx('dN',5);

  const rows=(j.values||[]).filter(v => Number(v[iDate])===lockedSerial);

  const A=[], B=[];
  rows.forEach((v,ix)=>{
    const rec={ seq:ix+1, id:String(v[iId]||''), name:String(v[iName]||''), dn:String(v[iDN]||''), shift:String(v[iShift]||'') };
    (rec.shift==='A'?A:B).push(rec);
  });
  el.count.textContent=String(rows.length);
  fillList(el.listA,A);
  fillList(el.listB,B);
}
function fillList(container,list){
  container.innerHTML='';
  if(!list.length){ container.innerHTML='<div class="empty">此日期無資料</div>'; return }
  const frag=document.createDocumentFragment();
  list.forEach(r=>{
    const div=document.createElement('div');
    div.className='row';
    div.innerHTML=`<div>${r.seq}</div><div>${r.id}</div><div title="${r.name}">${r.name}</div><div>${r.dn}</div>`;
    frag.appendChild(div);
  });
  container.appendChild(frag);
}

async function draw(){
  showMask('抽籤中…');
  try{
    const p=new URLSearchParams();
    p.append('action','lucky');
    p.append('dateSerial',lockedSerial);
    const r=await fetch(API_URL,{method:'POST',body:p});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j=await r.json();
    const msg = j.msg || '抽籤完成';
    el.toast.textContent=msg+'，10秒後刷新';
    el.toast.className='toast ok';

    setTimeout(()=>{ el.toast.textContent='讀取中…'; el.toast.className='toast'; }, 1000);
    setTimeout(()=>{ hideMask(); readData(); }, 10000);
  }catch(e){
    showMask('抽籤失敗','err');
    setTimeout(hideMask,1500);
  }
}

/* 事件 */
el.reload.onclick=readData;
el.draw.onclick=draw;

/* 啟動 */
lockToday();
tick(); setInterval(tick,1000);
ping(); setInterval(ping,45000);
readData();
/* 頁面被再次激活時，重算日期 */
document.addEventListener('visibilitychange',()=>{ if(!document.hidden){ lockToday(); }});
</script>
</body>
</html>