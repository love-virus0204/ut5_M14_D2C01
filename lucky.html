<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>抽籤執行系統</title>
<style>
:root {
  --bg:#0f172a;
  --fg:#e2e8f0;
  --accent:#10b981;
  --muted:#334155;
}
html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--fg);}
body{display:flex;flex-direction:column;overflow:hidden;}
.top{flex:0 0 auto;display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#1e293b;border-bottom:1px solid #334155;}
.status{font-size:.9em;}
.clock{font-family:monospace;font-size:1em;}
.btns{display:flex;gap:6px;}
.btn{padding:6px 10px;border:1px solid #475569;border-radius:8px;background:#1e293b;color:var(--fg);cursor:pointer;}
.btn:hover{background:#334155;}
.main{flex:1 1 auto;display:flex;flex-direction:column;overflow-y:auto;padding:10px;box-sizing:border-box;}
.select-bar{display:flex;align-items:center;justify-content:center;margin-bottom:8px;}
.sel{appearance:none;padding:6px 10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;font-size:1em;}
.rows{display:flex;flex-direction:column;gap:2px;}
.group{margin-top:8px;font-weight:bold;border-bottom:1px solid #334155;padding-bottom:4px;}
.row{display:grid;grid-template-columns:3ch 10ch 10ch auto;gap:6px;padding:4px 6px;border-bottom:1px solid #1e293b;}
.sep{height:8px;}
.mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.85);color:#fff;font-size:1.2em;z-index:10;}
.mask.show{display:flex;}
</style>
</head>
<body>
  <div class="top">
    <div class="status" id="gasStatus">檢查中…</div>
    <div class="clock" id="nowTime">--/-- --:--:--</div>
    <div class="btns">
      <button class="btn" id="btnRead">讀數據</button>
      <button class="btn" id="btnDraw">執行抽籤</button>
    </div>
  </div>

  <div class="main">
    <div class="select-bar">
      <select id="daySel" class="sel"></select>
    </div>
    <div id="rows" class="rows"></div>
  </div>

  <div id="mask" class="mask">處理中…</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';

/* ===== 時間控制 ===== */
function nowCorrected(){
  const p=new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,
  year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).formatToParts(new Date());
  const g=t=>Number(p.find(x=>x.type===t).value);
  return new Date(g('year'),g('month')-1,g('day'),g('hour'),g('minute'),g('second'));
}
function ymdToSerial(ymd){
  const [y,m,d]=ymd.split('-').map(Number);
  const epoch=Date.UTC(1899,11,30);
  return Math.floor((Date.UTC(y,m-1,d)-epoch)/86400000);
}
function fmtMDfromYMD(ymd){return ymd.slice(5).replace('-','/');}

/* ===== 日期選單 ===== */
const daySel=document.getElementById('daySel');
const T0=nowCorrected();
const baseYMD=new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit'}).format(T0);
const DAYS=Array.from({length:7},(_,k)=>{
  const d=new Date(T0.getFullYear(),T0.getMonth(),T0.getDate()+k);
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');
  const ymd=`${y}-${m}-${dd}`;
  return{ymd,serial:ymdToSerial(ymd),label:fmtMDfromYMD(ymd)};
});
daySel.innerHTML=DAYS.map((x,i)=>`<option value="${x.serial}"${i===0?' selected':''}>${x.label}</option>`).join('');
function currentSerial(){return Number(daySel.value);}
function currentMD(){const hit=DAYS.find(x=>x.serial===currentSerial());return hit?hit.label:'--/--';}

/* ===== 狀態顯示 ===== */
const gasStatus=document.getElementById('gasStatus');
async function pingGas(){
  try{
    const r=await fetch(API_URL+'?action=ping',{cache:'no-store'});
    const j=await r.json();
    gasStatus.textContent=(j.status==='ok')?'連線正常':'離線';
  }catch(e){gasStatus.textContent='錯誤';}
}
pingGas();
setInterval(pingGas,45000);

/* ===== 即時時間顯示 ===== */
function tick(){
  const t=nowCorrected();
  const s=`${String(t.getMonth()+1).padStart(2,'0')}/${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
  document.getElementById('nowTime').textContent=s;
}
tick(); setInterval(tick,1000);

/* ===== 遮罩控制 ===== */
const mask=document.getElementById('mask');
function showMask(t){mask.textContent=t;mask.classList.add('show');}
function hideMask(){mask.classList.remove('show');}

/* ===== 資料解析與渲染 ===== */
function renderResponse(j){
  const list = parseLuckyData(j);
  const serial = currentSerial();
  const rows = list.filter(r => Number(r.date)===serial)
                   .filter(r => ['A','B'].includes(String(r.shift||'').toUpperCase()));

  const A=[], B=[];
  rows.forEach(r => (String(r.shift).toUpperCase()==='A' ? A : B).push(r));

  const rowsEl = document.getElementById('rows');
  rowsEl.innerHTML = '';
  const frag = document.createDocumentFragment();
  frag.appendChild(group('A 班'));
  if (A.length===0) frag.appendChild(empty());
  let seqA=1;
  A.forEach(r => frag.appendChild(line(seqA++, r.id, r.name, r.dN)));
  frag.appendChild(sep());
  frag.appendChild(group('B 班'));
  if (B.length===0) frag.appendChild(empty());
  let seqB=1;
  B.forEach(r => frag.appendChild(line(seqB++, r.id, r.name, r.dN)));

  rowsEl.appendChild(frag);

  function cell(t){ const d=document.createElement('div'); d.textContent=t; return d; }
  function group(t){ const g=document.createElement('div'); g.className='group'; g.textContent=t; return g; }
  function sep(){ const s=document.createElement('div'); s.className='sep'; s.style.gridColumn='1/-1'; return s; }
  function empty(){ const r=document.createElement('div'); r.className='row'; r.append(cell('—'),cell('—'),cell('此日期無資料'),cell('—')); return r; }
  function line(n,id,name,dn){
    const r=document.createElement('div'); r.className='row';
    const nameCell=cell(name); nameCell.title=name;
    r.append(cell(n), cell(id), nameCell, cell(dn||'')); return r;
  }
}

/* ===== 通訊 ===== */
async function reloadData(){
  showMask('讀取中…');
  try{
    const p=new URLSearchParams();
    p.append('action','list_recent');
    p.append('dateSerial',currentSerial());
    const r=await fetch(API_URL,{method:'POST',body:p});
    const j=await r.json();
    renderResponse(j);
  }catch(e){showMask('讀取失敗');setTimeout(hideMask,1500);}
  finally{hideMask();}
}
async function draw(){
  showMask('抽籤中…');
  try{
    const p=new URLSearchParams();
    p.append('action','lucky');
    p.append('dateSerial',currentSerial());
    const r=await fetch(API_URL,{method:'POST',body:p});
    const j=await r.json();
    renderResponse(j);
    showMask('抽籤完成');
    setTimeout(hideMask,1000);
  }catch(e){showMask('抽籤失敗');setTimeout(hideMask,1500);}
}

/* ===== 綁定 ===== */
document.getElementById('btnRead').onclick=reloadData;
document.getElementById('btnDraw').onclick=draw;
window.addEventListener('load',reloadData);
</script>
</body>
</html>