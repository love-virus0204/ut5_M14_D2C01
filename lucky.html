<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>抽籤結果｜Lucky Draw Viewer</title>
<style>
  html,body{
    height:100%;margin:0;padding:0;
    background:#0b1120;color:#f1f5f9;
    font-family:"Noto Sans TC","Microsoft JhengHei",sans-serif;
    display:flex;flex-direction:column;
  }
  .top{
    flex:0 0 48px;
    display:flex;align-items:center;justify-content:space-between;
    background:#1e293b;padding:0 12px;box-shadow:0 2px 6px rgba(0,0,0,.3);
  }
  .time-box{display:flex;align-items:center;gap:12px;font-size:0.95em;}
  .btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:0.95em;}
  .btn.primary{background:#0ea5e9;color:#fff;}
  .btn.secondary{background:#334155;color:#f1f5f9;}
  .wrap{flex:1 1 auto;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:14px;}
  .block{background:#1e293b;border-radius:10px;padding:8px 10px;box-shadow:0 2px 8px rgba(0,0,0,.25);}
  .title{font-weight:600;margin-bottom:6px;font-size:1.05em;}
  .row{display:flex;justify-content:space-between;border-bottom:1px solid #475569;padding:4px 0;}
  .row:last-child{border-bottom:none;}
  .id{width:5em;text-align:left;}
  .name{flex:1 1 auto;}
  .dN{width:3em;text-align:center;}
  .mask{
    position:fixed;inset:0;background:rgba(0,0,0,.5);
    display:none;align-items:center;justify-content:center;
    color:#fff;font-size:1.2em;z-index:100;
  }
</style>
</head>
<body>
  <div class="top">
    <div class="time-box">
      <span id="ymd"></span>
      <span id="clock"></span>
    </div>
    <div class="time-box">
      <button class="btn secondary" id="btnGet">讀取資料</button>
      <button class="btn primary" id="btnDraw">執行抽籤</button>
    </div>
  </div>

  <div class="wrap" id="resultWrap"></div>
  <div class="mask" id="mask">執行中...</div>

<script>
/* ===== 時間（本機時間轉台北） ===== */
function nowCorrected(){
  const parts = new Intl.DateTimeFormat('zh-TW',{
    timeZone:'Asia/Taipei',hour12:false,
    year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  }).formatToParts(new Date());
  const get = (t)=> Number(parts.find(p=>p.type===t).value);
  return new Date(get('year'),get('month')-1,get('day'),get('hour'),get('minute'),get('second'));
}
function dateSerial(d){
  const epoch = Date.UTC(1899,11,30);
  return Math.floor((d.getTime()-epoch)/86400000);
}
function fmtDate(d){return d.toISOString().slice(0,10).replace(/-/g,'/');}

/* ===== UI ===== */
const elYMD=document.getElementById('ymd');
const elClock=document.getElementById('clock');
const elWrap=document.getElementById('resultWrap');
const elMask=document.getElementById('mask');
const btnGet=document.getElementById('btnGet');
const btnDraw=document.getElementById('btnDraw');
const GAS_URL='https://script.google.com/macros/s/你的GAS網址/exec';

/* ===== 定時刷新時間顯示 ===== */
function refreshClock(){
  const now=nowCorrected();
  elYMD.textContent=fmtDate(now).slice(5);
  elClock.textContent=now.toTimeString().slice(0,8);
}
setInterval(refreshClock,1000);
refreshClock();

/* ===== 資料解析器 ===== */
function parseLuckyData(data){
  if(!data || data.status!=='ok') return [];
  const F=Object.fromEntries(data.fields.map((k,i)=>[k,i]));
  return data.values.map(a=>({
    date:a[F.date], id:a[F.id], name:a[F.key], 
    shift:a[F.shift], dN:a[F.dN], lucky:a[F.lucky]
  }));
}

/* ===== 讀取與渲染 ===== */
async function reloadData(){
  showMask('讀取中...');
  try{
    const fd=new FormData();
    fd.append('action','list_lucky');
    const res=await fetch(GAS_URL,{method:'POST',body:fd});
    const j=await res.json();
    const list=parseLuckyData(j);
    renderLucky(list);
  }catch(e){alert('讀取失敗: '+e.message);}
  hideMask();
}

/* ===== 抽籤請求 ===== */
async function drawNow(){
  showMask('抽籤中...');
  try{
    const now=nowCorrected();
    const dateS=dateSerial(now);
    const fd=new FormData();
    fd.append('action','lucky');
    fd.append('dateSerial',dateS);
    const res=await fetch(GAS_URL,{method:'POST',body:fd});
    const j=await res.json();
    const list=parseLuckyData(j);
    renderLucky(list);
  }catch(e){alert('抽籤失敗: '+e.message);}
  hideMask();
}

/* ===== 分組渲染 ===== */
function renderLucky(list){
  elWrap.innerHTML='';
  if(!list.length){elWrap.textContent='無資料';return;}
  const groups={A:[],B:[]};
  list.forEach(r=>{
    if(r.shift==='A')groups.A.push(r);
    else if(r.shift==='B')groups.B.push(r);
  });
  for(const k of ['A','B']){
    const block=document.createElement('div');
    block.className='block';
    const t=document.createElement('div');
    t.className='title';
    t.textContent=`${k} 班 (${groups[k].length})`;
    block.appendChild(t);
    groups[k].forEach((r,i)=>{
      const row=document.createElement('div');
      row.className='row';
      row.innerHTML=`
        <div class="id">${i+1}</div>
        <div class="name">${r.id||''}</div>
        <div class="name">${r.name||''}</div>
        <div class="dN">${r.dN||''}</div>`;
      block.appendChild(row);
    });
    elWrap.appendChild(block);
  }
}

/* ===== 遮罩 ===== */
function showMask(msg){elMask.textContent=msg;elMask.style.display='flex';}
function hideMask(){elMask.style.display='none';}

/* ===== 綁定事件 ===== */
btnGet.onclick=reloadData;
btnDraw.onclick=drawNow;

/* ===== 頁面載入後自動讀取一次 ===== */
reloadData();
</script>
</body>
</html>