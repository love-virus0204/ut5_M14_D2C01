<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>抽籤執行系統</title>
<style>
:root {
  --bg:#0f172a;
  --fg:#e2e8f0;
  --accent:#10b981;
  --muted:#334155;
}
html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--fg);}
body{display:flex;flex-direction:column;overflow:hidden;}
.top{flex:0 0 auto;display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#1e293b;border-bottom:1px solid #334155;}
.clock{font-family:monospace;font-size:1em;}
.btns{display:flex;gap:6px;}
.btn:hover{background:#334155;}
//.btn{padding:6px 10px;border:1px solid #475569;border-radius:8px;background:#1e293b;color:var(--fg);cursor:pointer;}
//.select-bar{display:flex;align-items:center;justify-content:center;margin-bottom:8px;}
//.sel{appearance:none;padding:6px 10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;font-size:1em;}
.btn{display:inline-flex;align-items:center;height:32px;padding:0 10px;}
.select-bar{display:flex;align-items:center;justify-content:center;margin:0;}
.sel{display:inline-flex;align-items:center;height:32px;line-height:1;padding:0 10px;}
.main{flex:1 1 auto;display:flex;flex-direction:column;overflow-y:auto;padding:10px;box-sizing:border-box;}
//.rows{display:flex;flex-direction:column;gap:2px;}
.rows { display:flex; flex-direction: column; box-sizing: border-box; gap: 2px; width: 90%; margin: 0 auto;
}
.group{margin-top:8px;font-weight:bold;border-bottom:1px solid #334155;padding-bottom:4px;}
.row{display:grid;grid-template-columns:4ch 12ch auto 12ch ;gap:6px;padding:4px 6px;border-bottom:1px solid #1e293b;}
.sep{height:8px;}
.mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.85);color:#fff;font-size:1.2em;z-index:10;}
.mask.show{display:flex;}
.status{display:flex;align-items:center;gap:6px;font-size:.9em}
.dot{width:10px;height:10px;border-radius:50%;background:#64748b}
.dot.ok{background:#10b981}
.dot.err{background:#ef4444}

.group.A {
  color: #38bdf8;
  background: #38bdf820;}
.row.A .cell {
  color: #bae6fd;}
.group.B {
  color: #f87171;
  background: #f8717120;}
.row.B .cell {
  color: #fecaca;}
</style>
</head>
<body>
<div class="top">
  <!-- 狀態燈 -->
  <div class="status" id="gasStatus">
    <span class="dot" id="gasDot"></span>
    <span id="gasText">n/a</span>
  </div>

  <!-- 抽籤按鈕 -->
  <div class="btns">
    <button class="btn" id="btnDraw">抽籤</button></div>

  <!-- 時間顯示 -->
  <div class="clock" id="nowTime">--/-- --:--:--</div>

  <!-- 日期選單 -->
  <div class="select-bar">
    <select id="daySel" class="sel"></select></div>

  <!-- 讀表按鈕 -->
  <div class="btns">
    <button class="btn" id="btnRead">讀表</button></div>
</div>

<div class="main">
  <div id="rows" class="rows"></div>
</div>

<div id="mask" class="mask">處理中…</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';

/* ===== 時間控制 ===== */
function nowCorrected(){
  const p=new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,
  year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).formatToParts(new Date());
  const g=t=>Number(p.find(x=>x.type===t).value);
  return new Date(g('year'),g('month')-1,g('day'),g('hour'),g('minute'),g('second'));
}
function ymdToSerial(ymd){
  const [y,m,d]=ymd.split('-').map(Number);
  const epoch=Date.UTC(1899,11,30);
  return Math.floor((Date.UTC(y,m-1,d)-epoch)/86400000);
}
function fmtMDfromYMD(ymd){return ymd.slice(5).replace('-','/');}

/* ===== 日期選單 ===== */
const daySel=document.getElementById('daySel');
const T0=nowCorrected();
const baseYMD=new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit'}).format(T0);
const DAYS=Array.from({length:7},(_,k)=>{
  const d=new Date(T0.getFullYear(),T0.getMonth(),T0.getDate()+k);
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');
  const ymd=`${y}-${m}-${dd}`;
  return{ymd,serial:ymdToSerial(ymd),label:fmtMDfromYMD(ymd)};
});
daySel.innerHTML=DAYS.map((x,i)=>`<option value="${x.serial}"${i===0?' selected':''}>${x.label}</option>`).join('');
function currentSerial(){return Number(daySel.value);}
function currentMD(){const hit=DAYS.find(x=>x.serial===currentSerial());return hit?hit.label:'--/--';}

/* ===== 狀態顯示 ===== */
const gasDot  = document.getElementById('gasDot');
const gasText = document.getElementById('gasText');

function setGas(status){
  if(!gasDot || !gasText) return;
  gasDot.className = 'dot' + (status==='GAS' ? ' ok' : status==='GG' ? ' err' : '');
  gasText.textContent = status;
}
setGas('n/a');
async function pingGas(){
  try{
    const res = await fetch(API_URL + '?target=ping', { cache:'no-store' });
    const j = await res.json();
    setGas(j.status === 'ok' ? 'GAS' : 'GG');
  }catch(e){
    setGas('GG');
  }
}

  pingGas();
  setInterval(pingGas, 45000);

/* ===== 即時時間顯示 ===== */
function tick(){
  const t=nowCorrected();
  const s=`${String(t.getMonth()+1).padStart(2,'0')}/${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
  document.getElementById('nowTime').textContent=s;
}
tick(); setInterval(tick,1000);

/* ===== 遮罩控制 ===== */
const mask=document.getElementById('mask');
function showMask(t){mask.textContent=t;mask.classList.add('show');}
function hideMask(){mask.classList.remove('show');}

/* ===== 資料解析 ===== */
function parseLuckyData(data){
  if(!data||data.status!=='ok')return[];
  const F=Object.fromEntries(data.fields.map((k,i)=>[k,i]));
  return data.values.map(a=>({ date:a[F.date],id:a[F.id],shift:a[F.shift],dN:a[F.dN],name:a[F.name],tier:a[F.lucky]
  }));
}

/* ===== 資料渲染 ===== */
function renderResponse(j){
  const list = parseLuckyData(j);
  const serial = currentSerial();
  const rows = list
  .filter(r => Number(r.date) === serial)
  .filter(r => ['A','B'].includes(String(r.shift || '').toUpperCase()))
  .filter(r => Number(r.tier) < 3000);

  const A=[], B=[];
  rows.forEach(r => (String(r.shift).toUpperCase()==='A' ? A : B).push(r));

  const rowsEl = document.getElementById('rows');
  rowsEl.innerHTML = '';
  const frag = document.createDocumentFragment();
  frag.appendChild(group('Ａ','a'));
  if (A.length===0) frag.appendChild(empty());
  let seqA=1;
  A.forEach(r => frag.appendChild(line(seqA++, r.id, r.name, r.dN,'a')));
  frag.appendChild(sep());
  frag.appendChild(group('Ｂ','b'));
  if (B.length===0) frag.appendChild(empty());
  let seqB=1;
  B.forEach(r => frag.appendChild(line(seqB++, r.id, r.name, r.dN,'b')));

  rowsEl.appendChild(frag);
  function cell(t){ const d=document.createElement('div'); d.textContent=t; return d; }
function group(t,cls){
  const g = document.createElement('div');
  g.className = 'group ' + cls.toUpperCase();
  g.append(cell(t),cell('ＩＤ'),cell('姓　名'),cell('假別'));
  return g;
}
  function sep(){ const s=document.createElement('div'); s.className='sep'; s.style.gridColumn='1/-1'; return s; }
  function empty(){ const r=document.createElement('div'); r.className='row'; r.append(cell('—'),cell('—'),cell('無資料'),cell('—')); return r; }
  function line(n,id,name,dn,cls){
    const r=document.createElement('div'); 
    r.className = 'row ' + cls.toUpperCase();
    r.append(cell(n), cell(id), cell(name), cell(dn)) ; return r;
  }
}

/* ===== 通訊 ===== */
async function reloadData(){
  showMask('讀取中…');
  try{
    const p=new URLSearchParams();
    p.append('action','list_recent');
    p.append('dateSerial',currentSerial());
    const r=await fetch(API_URL,{method:'POST',body:p});
    const j=await r.json();
    renderResponse(j);
  }catch(e){showMask('讀取失敗');setTimeout(hideMask,1500);}
  finally{hideMask();}
}
async function draw(){
  showMask('抽籤中…');
  try{
    const p=new URLSearchParams();
    p.append('action','lucky');
    p.append('dateSerial',currentSerial());
    const r=await fetch(API_URL,{method:'POST',body:p});
    const j=await r.json();
    renderResponse(j);
    showMask('抽籤完成');
    setTimeout(hideMask,1000);
  }catch(e){showMask('抽籤失敗');setTimeout(hideMask,1500);}
}

/* ===== 綁定 ===== */
document.getElementById('btnRead').onclick=reloadData;
document.getElementById('btnDraw').onclick=draw;
window.addEventListener('load',reloadData);
</script>
</body>
</html>