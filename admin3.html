<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>資料庫管理頁 final</title>
<style>
  :root { --min-font:16px; --card-w:90vw; --gap:12px; }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;font-size:var(--min-font);background:#f5f6f8;line-height:1.4;}
  *{box-sizing:border-box;}
  .page{height:100%;display:flex;flex-direction:column;}

  /* 工具列：左 GAS 狀態 / 右 台北時間 */
  .toolbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#fff;border-bottom:1px solid #e5e7eb;}
  .badge{padding:2px 10px;border-radius:999px;border:1px solid #cfd8dc;color:#64748b;}
  .badge.ok{border-color:#10b981;color:#047857;}
  .badge.err{border-color:#ef4444;color:#b91c1c;}
  .clock{font-variant-numeric:tabular-nums;color:#334155;}

  /* 上：渲染卡片（90% 寬置中，允許橫向捲動） */
  .top{flex:1 1 auto;min-height:0;display:flex;justify-content:center;padding:14px 0;}
  .card{width:var(--card-w);background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);display:flex;flex-direction:column;min-height:0;}
  .card-head{padding:10px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e5e7eb;}
  .card-body{flex:1 1 auto;min-height:0;overflow:auto;}
  table{border-collapse:collapse;table-layout:fixed;min-width:600px;width:100%;}
  thead th{position:sticky;top:0;background:#fff;z-index:1;}
  th,td{border-bottom:1px solid #f1f5f9;padding:10px 8px;text-align:center;color:#334155;}
  tr:hover{background:#f8fafc;cursor:pointer;}
  /* 欄寬與置中 */
  th.col-id,td.col-id{width:7ch;}
  th.col-name,td.col-name{width:12em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  th.col-tier,td.col-tier{width:5ch;white-space:nowrap;}
  th.col-limit,td.col-limit{width:10ch;}

  /* 下：輸入卡片（固定 2×3） */
  .bottom{flex:0 0 auto;border-top:1px solid #e5e7eb;background:#fff;}
  .form-wrap{width:var(--card-w);margin:12px auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:12px;}
  .grid23{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-areas:
      "id name blank"
      "tier limit submit";
    gap: var(--gap);
    align-items:end;
  }
  .field{display:flex;flex-direction:column;gap:6px;}
  .field label{font-size:.92em;color:#64748b;}
  .cell-id{grid-area:id;}
  .cell-name{grid-area:name;}
  .cell-blank{grid-area:blank;}
  .cell-tier{grid-area:tier;}
  .cell-limit{grid-area:limit;}
  .cell-submit{grid-area:submit;display:flex;align-items:end;justify-content:flex-end;}
  .ctl{padding:10px 12px;font-size:1em;border:1px solid #cbd5e1;border-radius:10px;background:#fff;color:#0f172a;}
  .btn{padding:10px 16px;font-size:1em;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer;transition:transform .02s ease, box-shadow .2s;}
  .btn.primary{background:#10b981;color:#fff;border-color:#10b981;}
  .btn.secondary{background:#f8fafc;}
  .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.08);}
  .btn:active{transform:translateY(1px);}

  /* 遮罩 */
  #mask{position:fixed;inset:0;background:rgba(2,6,23,.15);display:none;align-items:center;justify-content:center;z-index:999;}
  .loader{width:44px;height:44px;border:4px solid #e2e8f0;border-top:4px solid #0f172a;border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="page">
  <div class="toolbar">
    <span>GAS 狀態：<span id="gasStatus" class="badge">--</span></span>
    <span id="clock" class="clock">--:--:--</span>
  </div>

  <!-- 渲染卡片 -->
  <section class="top">
    <div class="card">
      <div class="card-head">
        <strong>資料庫列表</strong>
        <button id="btnReload" class="btn secondary">更新</button>
      </div>
      <div class="card-body">
        <table>
          <thead>
            <tr>
              <th class="col-id">ID</th>
              <th class="col-name">名字</th>
              <th class="col-tier">級距</th>
              <th class="col-limit">日期</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 2×3 輸入網格 -->
  <section class="bottom">
    <div class="form-wrap">
      <form class="grid23" onsubmit="return false;">
        <!-- 第1行：ID | 名字 | 空白 -->
        <div class="field cell-id">
          <label for="id">ID（5碼英數大寫）</label>
          <input id="id" class="ctl" maxlength="5" autocomplete="off" />
        </div>
        <div class="field cell-name">
          <label for="name">名字</label>
          <input id="name" class="ctl" autocomplete="off" />
        </div>
        <div class="field cell-blank"><label>&nbsp;</label><div>&nbsp;</div></div>
        <!-- 第2行：級距 | limit | 上傳 -->
        <div class="field cell-tier">
          <label for="tier">級距（0–5，預設3）</label>
          <select id="tier" class="ctl">
            <option>0</option><option>1</option><option>2</option>
            <option selected>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="field cell-limit">
          <label for="limit">limit（天數；可空）</label>
          <input id="limit" class="ctl" type="number" inputmode="numeric" min="0" step="1" />
        </div>
        <div class="field cell-submit">
          <button id="btnUpload" class="btn primary">上傳</button>
        </div>
      </form>
    </div>
  </section>
</div>

<!-- 遮罩 -->
<div id="mask"><div class="loader"></div></div>

<script>
/* 設定 */
 const GAS_URL = 'https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';

const rows=document.getElementById('rows');
const gas=document.getElementById('gasStatus');
const clock=document.getElementById('clock');
const mask=document.getElementById('mask');
const idE=document.getElementById('id');
const nameE=document.getElementById('name');
const tierE=document.getElementById('tier');
const limitE=document.getElementById('limit');

const rowById=Object.create(null);
let uploadCount=0;

/* 台北時鐘（唯一時間來源） */
let nowTPE=new Date();
function tick(){ nowTPE=getNowTPE(); clock.textContent=formatYMDHMS(nowTPE); }
setInterval(tick,1000); tick();
function getNowTPE(){
  const fmt=new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const o=Object.fromEntries(fmt.formatToParts(new Date()).map(p=>[p.type,p.value]));
  return new Date(Date.UTC(+o.year,+o.month-1,+o.day,+o.hour,+o.minute,+o.second));
}
function z(n){return String(n).padStart(2,'0');}
function formatYMD(d){ return d.getUTCFullYear()+'-'+z(d.getUTCMonth()+1)+'-'+z(d.getUTCDate()); }
function formatYMDHMS(d){ return formatYMD(d)+' '+z(d.getUTCHours())+':'+z(d.getUTCMinutes())+':'+z(d.getUTCSeconds()); }

/* Excel/試算表序號工具 */
const EPOCH=Date.UTC(1899,11,30);
function serialToYmd(n){
  if(typeof n!=='number' || !isFinite(n)) return '';
  const ms=n*86400000+EPOCH;
  const dt=new Date(ms);
  return formatYMD(new Date(Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate())));
}
function baseSerial(d){ return Math.floor((Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-EPOCH)/86400000); }

/* 遮罩 */
function showMask(){mask.style.display='flex';}
function hideMask(){mask.style.display='none';}

/* GAS 健康檢查（GET） */
function ping(){
  fetch(GAS_URL+'?ping=1',{cache:'no-store'})
    .then(r=>{ gas.textContent=r.ok?'OK':'ERR'; gas.className=r.ok?'badge ok':'badge err'; })
    .catch(()=>{ gas.textContent='ERR'; gas.className='badge err'; });
}
ping(); setInterval(ping,45000);

/* 渲染：0=>永久；數字=>yyyy-mm-dd；其他/空=>空字串 */
function render(values){
  rows.innerHTML='';
  for(const v of values){
    const id=v[0], name=v[1], tier=v[2], raw=v[3];
    const ymd=(raw===0||raw==='0') ? '永久' : (typeof raw==='number' ? serialToYmd(raw) : (raw||''));
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="col-id" title="${id}">${id}</td>
      <td class="col-name" title="${name}">${name}</td>
      <td class="col-tier" title="${tier}">${tier}</td>
      <td class="col-limit" title="${ymd}">${ymd}</td>`;
    tr.onclick=()=>fill(id,name,tier);
    rows.appendChild(tr);
    rowById[id]=tr;
  }
}

/* 點列帶入（limit 清空，由使用者輸入數字） */
function fill(id,name,tier){
  idE.value=id||'';
  nameE.value=name||'';
  tierE.value=String(tier??3);
  limitE.value='';
  document.querySelector('.bottom').scrollIntoView({behavior:'smooth',block:'nearest'});
}

/* 讀取 */
function reload(){
  showMask();
  const p=new URLSearchParams(); p.append('action','list_recent2');
  fetch(GAS_URL,{method:'POST',body:p})
    .then(r=>r.json())
    .then(d=>{ if(d.status==='ok') render(d.values||[]); })
    .catch(console.error)
    .finally(hideMask);
}

/* 表尾插入或替換舊列 */
function appendOrReplaceBottom(p){
  const old=rowById[p.id]; if(old) old.remove();
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td class="col-id" title="${p.id}">${p.id}</td>
    <td class="col-name" title="${p.name}">${p.name}</td>
    <td class="col-tier" title="${p.tier}">${p.tier}</td>
    <td class="col-limit" title="${p.ymd||''}">${p.ymd||''}</td>`;
  tr.onclick=()=>fill(p.id,p.name,p.tier);
  rows.appendChild(tr);
  rowById[p.id]=tr;
}

/* 上傳：limit>0 才換算；空或 0 → 傳空字串 */
function upload(){
  const id=(idE.value||'').trim().toUpperCase();
  const name=(nameE.value||'').trim();
  const tier=parseInt(tierE.value,10);
  const limit=(limitE.value||'').trim();

  if(!/^[A-Z0-9]{5}$/.test(id)) return alert('ID 需為 5 碼英數大寫');
  if(!name) return alert('名字不得為空');
  if(Number.isNaN(tier)||tier<0||tier>5) return alert('級距需 0–5');
  if(limit!=='' && !/^[0-9]+$/.test(limit)) return alert('limit 僅允許純數字');

  let serial='', ymd='';
  if(limit!=='' && Number(limit)>0){
    const m=nowTPE.getUTCHours()*60 + nowTPE.getUTCMinutes();
    const base=new Date(nowTPE);
    if(m<500) base.setUTCDate(base.getUTCDate()-1);
    serial = baseSerial(base) + Number(limit);
    ymd = serialToYmd(serial);
  }

  showMask();
  const form=new URLSearchParams();
  form.append('action','upsert');
  form.append('id',id);
  form.append('name',name);
  form.append('tier',String(tier));
  form.append('limit_date',String(serial));   // '' 或 數字字串

  fetch(GAS_URL,{method:'POST',body:form})
    .then(r=>r.json())
    .then(res=>{
      if(res.status==='ok'){
        appendOrReplaceBottom({id,name,tier,ymd});
        if(++uploadCount>=10){ uploadCount=0; reload(); }
        idE.value=''; nameE.value=''; tierE.value='3'; limitE.value='';
      }else{
        alert(res.msg||'上傳失敗');
      }
    })
    .catch(e=>{ console.error(e); alert('上傳錯誤'); })
    .finally(hideMask);
}

/* 綁定 */
document.getElementById('btnReload').onclick=reload;
document.getElementById('btnUpload').onclick=upload;
idE.oninput=()=>{ idE.value=idE.value.toUpperCase().replace(/[^A-Z0-9]/g,''); };
limitE.oninput=()=>{ limitE.value=limitE.value.replace(/[^\d]/g,''); };
window.onload=reload;
</script>
</body>
</html>