<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>報名記錄表｜瀏覽</title>
<style>
  :root{ --bg:#f8fafc; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --brand:#0f766e; --ok:#10b981; --err:#ef4444; }
  html,body{height:100%}
  body{margin:0;background:#f8fafc;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{width:96%;max-width:980px;margin:2px auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .hdr{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}
  .ttl{font-weight:700;color:#0f766e}
  .back{font-size:12px;color:#64748b;text-decoration:none;border:1px solid #e5e7eb;padding:6px 10px;border-radius:8px}
  .content{padding:0 16px 14px}
  #status{color:#475569;margin:28px 0;min-height:1.6em;text-align:center;font-weight:600}
  #dbg{display:none;white-space:pre-wrap;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:8px;padding:8px;margin-top:8px;color:#334155}
  .grp{margin:12px 0 6px;font-weight:700}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-top:1px solid #ddd;text-align:center;padding:6px 4px}
  thead th{background:#f3f4f6;color:#334155}
  table.t1 tbody tr:nth-child(odd){background:#f5f3ff}
  table.t1 tbody tr:nth-child(even){background:#ede9fe}
  table.t2 tbody tr:nth-child(odd){background:#f9fafb}
  table.t2 tbody tr:nth-child(even){background:#e5e7eb}
  table.t3 tbody tr:nth-child(odd){background:#fff7ed}
  table.t3 tbody tr:nth-child(even){background:#ffedd5}
  #root table tbody tr:hover{background:#e0f2fe}
  .foot{padding:10px 30px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;color:#64748b;font-size:12px}
  .net{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#d1d5d9;border:1px solid #cbd5e1}
  .ok{background:#10b981!important;border-color:#10b981!important}
  .err{background:#ef4444!important;border-color:#ef4444!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hdr">
      <div class="ttl">僅瀏覽｜最近兩班有效紀錄</div>
      <a href="index.html" class="back">返回入口</a>
    </div>
    <div class="content">
      <div id="status">努力加載中... 60s</div>
      <div id="root" style="display:none"></div>
      <div id="dbg"></div>
    </div>
    <div class="foot">
      <div class="net"><span id="net-dot" class="dot"></span><span id="net-msg">回傳</span></div>
      <div>版本 browse v0.1.1　|　<span id="now"></span></div>
    </div>
  </div>
</div>

<script>
/* API URL */
const API_BASE = 'https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';

const baseUTC = Date.UTC(1899,11,30);

// 時鐘
(function tick(){
  const el = document.getElementById('now');
  const tz = "Asia/Taipei";
  const opt = { timeZone:tz, year:'numeric', month:'2-digit',  day:'2-digit', hour:'2-digit',  minute:'2-digit', second:'2-digit', hour12:false };
  el.textContent = new
  Intl.DateTimeFormat('zh-TW', opt).format(new Date());
  setTimeout(tick, 1000);
})();

/* 指示燈 */
function setNetLight(msg){
  const dot = document.getElementById('net-dot');
  const txt = document.getElementById('net-msg');
  dot.classList.remove('ok','err');
  dot.classList.add(msg ? 'ok' : 'err');
  txt.textContent = msg ? "GAS" : "回傳";
}

/* timeout fetch */
function fetchWithTimeout(url, options, timeout){
  return Promise.race([
    fetch(url, options),
    new Promise((_, rej)=>setTimeout(()=>rej(new Error("Timeout "+timeout+"ms")), timeout))
  ]);
}

/* 倒數 */
function startCountdown(sec){
  const status = document.getElementById('status');
  let left = sec;
  status.textContent = "努力加載中... " + left + "s";
  const t = setInterval(()=>{
    left--;
    status.textContent = "努力加載中... " + left + "s";
    if (left <= 0){
      clearInterval(t);
      if (!window.__renderDone__){
        status.textContent = "載入失敗..請通知開發人員";
      }
    }
  }, 1000);
  return { stop(){ clearInterval(t); } };
}

/* 先 GET 檢查 */
async function pingGET(){
  try {
    const res = await fetchWithTimeout(API_BASE + "?action=list_recent", {method:"GET"}, 5000);
    if (!res.ok) throw new Error("HTTP " + res.status);
    setNetLight("OK");
    return true;
  } catch(e) {
    setNetLight(); document.getElementById('status').textContent = "載入失敗..請通知開發人員";
    return false;
  }
}

/* POST 取資料 */
async function fetchRecentPOST(){
  const res = await fetch(API_BASE, { method:"POST", body:new URLSearchParams({action:"list_recent"}) });
  if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
  const data = await res.json();
  if (data?.status !== "ok" || !Array.isArray(data.fields) || !Array.isArray(data.values)){
    throw new Error("需 {status:'ok', fields[], values[]}");
  }
  const F = Object.fromEntries(data.fields.map((k,i)=>[k,i]));
  return data.values.map(a => ({
    submittedAt: a[F.submittedAt],
    key:         a[F.key],
    date:        Number(a[F.date]),
    id:          a[F.id],
    shift:       a[F.shift],
    dN:          a[F.dN],
    admin_id:    a[F.admin_id],
    deletedAt:   a[F.deletedAt],
    lucky:       a[F.lucky],
    row:         a[F.row]
  }));
}




// 先依日期切兩張表 → 每表內再拆 A/B 並配對
function groupForRender(rows){
  // 1) 依日期保序分箱
  const byDate = new Map();            // key: serial(Number) → Array<row>
  const order  = [];
  for(const r of rows){
    const ds = Number(r.date);
    if(!Number.isFinite(ds)) continue;
    if(!byDate.has(ds)){ byDate.set(ds, []); order.push(ds); }
    byDate.get(ds).push(r);
    if(order.length === 2 && ds !== order[0] && ds !== order[1]) break; // 最多兩張
  }

  // 2) 每張表：拆 A / B → 行數對齊成 {a,b}
  const out = [];
  for(const serial of order.slice(0,2)){
    const list = byDate.get(serial);
    const A = [], B = [];
    for(const r of list){
      const sh = String(r.shift).trim().toUpperCase();
      const item = { id: r.id ?? "", dN: r.dN ?? "" };
      if(sh === 'A') A.push(item);
      else if(sh === 'B') B.push(item);
    }
    const max = Math.max(A.length, B.length);
    const rows2 = Array.from({length:max}, (_,i)=>({ a: A[i]||null, b: B[i]||null }));
    out.push({ serial, rows: rows2 });
  }
  return out;
}

// 渲染：每列顯示 "id, dN | id, dN"
function render(groups){
  const root = document.getElementById('root');
  root.innerHTML = '';

  const mmdd = n=>{
    const t = new Date((Number(n)-25569)*86400000);
    const m = String(t.getUTCMonth()+1).padStart(2,'0');
    const d = String(t.getUTCDate()).padStart(2,'0');
    return `${m}/${d}`;
  };

  if(!groups.length){
    root.innerHTML = '<section><div class="grp">　--/--</div><table class="t1"><tbody><tr><td>目前無資料</td><td></td></tr></tbody></table></section>';
    return;
  }

  groups.forEach((g, idx)=>{
    const sec = document.createElement('section');

    const hdr = document.createElement('div');
    hdr.className = 'grp';
    hdr.textContent = '　' + mmdd(g.serial);
    sec.appendChild(hdr);

    const table = document.createElement('table');
    table.className = 't' + ((idx % 3) + 1);
    table.innerHTML = '<thead><tr><th>A（id, dN）</th><th>B（id, dN）</th></tr></thead><tbody></tbody>';
    const tb = table.querySelector('tbody');

    for(const r of g.rows){
      const left  = r.a ? `${r.a.id}, ${r.a.dN}` : '';
      const right = r.b ? `${r.b.id}, ${r.b.dN}` : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${left}</td><td>${right}</td>`;
      tb.appendChild(tr);
    }

    sec.appendChild(table);
    root.appendChild(sec);
  });
}








/* 日期序號 → mm/dd */
function serialToMMDD(n){
  const days = Math.floor(Number(n));
  const dt = new Date(baseUTC + days*86400000);
  const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
  const dd = String(dt.getUTCDate()).padStart(2,"0");
  return mm + "/" + dd;
}

/* 主流程：倒數→GET→POST→渲染 */
async function loadAndRender(){
  window.__renderDone__ = false;
  const status = document.getElementById('status');
  const root = document.getElementById('root');
  const dbg = document.getElementById('dbg');
  root.style.display = "none"; dbg.style.display = "none";

  const cd = startCountdown(60);

  const ok = await pingGET();
  if (!ok){ cd.stop(); return; }

  try{
    const rows = await fetchRecentPOST();
    const groups = groupForRender(rows);
    render(groups);
    status.style.minHeight = "0";
    status.textContent = "";
    status.style.margin = "0px 0";
    root.style.display = "";
    window.__renderDone__ = true;
    cd.stop();
  }catch(e){
    status.textContent = "載入失敗..請通知開發人員";
    dbg.style.display = "block";
    dbg.textContent = (e && e.message) ? e.message : String(e);
    // 維持綠燈，表 GET 成功但 POST/解析失敗
  }
}

document.addEventListener('DOMContentLoaded', loadAndRender);
</script>
</body>
</html>