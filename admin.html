<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>資料庫管理頁</title>
<style>
  :root { --min-font:16px; --gap:10px; --bar-h:64px; }
  html, body { height:100%; margin:0; font-family:system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif; font-size:var(--min-font); }
  * { box-sizing:border-box; }
  .page { height:100%; display:flex; flex-direction:column; }

  /* 頂部工具列（含 GAS 狀態與時鐘） */
  .toolbar { position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between;
             padding:8px 12px; border-bottom:1px solid #ddd; background:#fff; }
  .toolbar .left { display:flex; align-items:center; gap:8px; }
  .badge { padding:2px 8px; border-radius:999px; font-size:0.9em; border:1px solid #ccc; }
  .badge.ok { color:#0a5; border-color:#0a5; }
  .badge.err { color:#c33; border-color:#c33; }
  .clock { font-variant-numeric:tabular-nums; opacity:.85; }

  /* 上：清單，可捲動 */
  .top { flex:1 1 auto; min-height:0; display:flex; flex-direction:column; }
  .top-inner { flex:1 1 auto; min-height:0; overflow:auto; padding:8px 12px; }
  .top-actions { padding:8px 12px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:8px; background:#fafafa; }

  /* 表格 */
  table { width:100%; border-collapse:collapse; table-layout:fixed; }
  thead th { position:sticky; top:0; background:#fff; z-index:2; }
  th, td { border-bottom:1px solid #eee; padding:8px; word-wrap:break-word; word-break:break-all; }
  /* 欄寬以中文 5 字為主（大約 5em）；ID 用 7ch；tier 用 3ch */
  th.col-id, td.col-id { width: 7ch; }
  th.col-name, td.col-name { width: 6em; }       /* 約 5-6 個全形字 */
  th.col-tier, td.col-tier { width: 3ch; text-align:center; }
  th.col-limit, td.col-limit { width: 7.5em; }   /* yyyy-mm-dd */
  tr:hover { background:#f6f7f8; cursor:pointer; }

  /* 下：輸入區固定 */
  .bottom { flex:0 0 auto; border-top:1px solid #ddd; padding:10px 12px; background:#fafafa; }
  .form { display:flex; flex-wrap:wrap; gap:var(--gap); align-items:flex-end; max-width:100%; }
  .field { display:flex; flex-direction:column; gap:6px; }
  .field label { font-size:0.92em; color:#555; }
  .field input[type="text"],
  .field input[type="number"],
  .field select { padding:8px 10px; font-size:1em; min-width: 6em; }
  .w-id { width: 8ch; }
  .w-name { width: 7em; }       /* ~5字 */
  .w-tier { width: 6ch; }
  .w-limit { width: 8ch; }
  .actions { display:flex; gap:10px; margin-left:auto; }
  button { padding:8px 14px; font-size:1em; border:1px solid #ccc; background:#fff; border-radius:8px; cursor:pointer; }
  button.primary { background:#0a5; color:#fff; border-color:#0a5; }
  button:disabled { opacity:.55; cursor:not-allowed; }

  /* 微遮罩 */
  #mask { position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; align-items:center; justify-content:center; z-index:999; }
  .loader { width:40px; height:40px; border:4px solid #f0f0f0; border-top:4px solid #333; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* 行動輸入捲動優化 */
  .restore-note { display:none; font-size:.85em; color:#888; }
</style>
</head>
<body>
<div class="page">

  <!-- 工具列：左=GAS狀態；右=台北時間 -->
  <div class="toolbar">
    <div class="left">
      <span>GAS 狀態：</span><span id="gasStatus" class="badge">--</span>
    </div>
    <div class="right">
      <span class="clock" id="clock">--:--:--</span>
    </div>
  </div>

  <!-- 上：可捲動清單 -->
  <section class="top">
    <div class="top-inner">
      <table>
        <thead>
          <tr>
            <th class="col-id">ID</th>
            <th class="col-name">姓名</th>
            <th class="col-tier">級距</th>
            <th class="col-limit">限定日期</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="top-actions">
      <button id="btnReload">更新</button>
    </div>
  </section>

  <!-- 下：固定輸入區 -->
  <section class="bottom">
    <form class="form" onsubmit="return false;">
      <div class="field">
        <label for="id">ID（5 碼英數大寫）</label>
        <input id="id" class="w-id" type="text" maxlength="5" inputmode="latin" autocomplete="off" />
      </div>
      <div class="field">
        <label for="name">姓名</label>
        <input id="name" class="w-name" type="text" autocomplete="off" />
      </div>
      <div class="field">
        <label for="tier">級距（0–5，預設 3）</label>
        <select id="tier" class="w-tier">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
      <div class="field">
        <label for="limit">limit（天數；純數字，可空）</label>
        <input id="limit" class="w-limit" type="number" inputmode="numeric" min="0" step="1" />
      </div>
      <div class="actions">
        <button id="btnUpload" class="primary">上傳</button>
      </div>
      <div class="restore-note" id="restoreNote">已恢復視窗位置</div>
    </form>
  </section>
</div>

<!-- 微遮罩 -->
<div id="mask"><div class="loader"></div></div>

<script>
  // ====== 設定 ======
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbw1jdsG18FEoO2x-CgkOUXdFIpotUy3xJsJQBKf-FKuFQyKt2DLqLShtBuxNwoOjynj/exec';

  const rows = document.getElementById('rows');
  const mask = document.getElementById('mask');
  const gasBadge = document.getElementById('gasStatus');
  const clockEl = document.getElementById('clock');
  const rowById = Object.create(null);
  let uploadCount = 0;

  // 唯一時間來源：台北時區現在時間（每秒更新 nowTPE 與畫面顯示）
  let nowTPE = new Date();
  function tickClock(){
    nowTPE = getNowInTPE(); // 更新唯一時間來源
    clockEl.textContent = formatYMDHMS(nowTPE);
  }
  setInterval(tickClock, 1000);
  tickClock();

  // ====== 工具：台北時間、序號轉換 ======
  function getNowInTPE(){
    const now = new Date();
    const f = new Intl.DateTimeFormat('zh-TW', {
      timeZone: 'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
    });
    const parts = f.formatToParts(now);
    const obj = Object.fromEntries(parts.map(p=>[p.type, p.value]));
    const y = parseInt(obj.year,10);
    const m = parseInt(obj.month,10);
    const d = parseInt(obj.day,10);
    const hh = parseInt(obj.hour,10);
    const mm = parseInt(obj.minute,10);
    const ss = parseInt(obj.second,10);
    return new Date(Date.UTC(y, m-1, d, hh, mm, ss));
  }
  function formatYMD(dateUTC){
    const z = n => String(n).padStart(2,'0');
    return dateUTC.getUTCFullYear() + '-' + z(dateUTC.getUTCMonth()+1) + '-' + z(dateUTC.getUTCDate());
  }
  function formatYMDHMS(dateUTC){
    const z = n => String(n).padStart(2,'0');
    return formatYMD(dateUTC) + ' ' + z(dateUTC.getUTCHours()) + ':' + z(dateUTC.getUTCMinutes()) + ':' + z(dateUTC.getUTCSeconds());
  }
  const EXCEL_EPOCH_UTC = Date.UTC(1899, 11, 30);
  function serialToYmd(n){
    if (typeof n !== 'number' || !isFinite(n)) return '';
    const ms = n * 86400000 + EXCEL_EPOCH_UTC;
    const dt = new Date(ms);
    return formatYMD(new Date(Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate())));
  }
  function baseSerialFromTPE(dateUTC){
    const y = dateUTC.getUTCFullYear();
    const m = dateUTC.getUTCMonth();
    const d = dateUTC.getUTCDate();
    const baseMs = Date.UTC(y, m, d) - EXCEL_EPOCH_UTC;
    return Math.floor(baseMs / 86400000);
  }

  // ====== 微遮罩 ======
  function showMask(){ mask.style.display='flex'; }
  function hideMask(){ mask.style.display='none'; }

  // ====== GAS 狀態（GET） ======
  function pingGas(){
    fetch(GAS_URL + '?ping=1', { method:'GET', cache:'no-store' })
      .then(r=>{
        if (r.ok) { gasBadge.textContent='OK'; gasBadge.className='badge ok'; }
        else { gasBadge.textContent='ERR'; gasBadge.className='badge err'; }
      })
      .catch(_=>{ gasBadge.textContent='ERR'; gasBadge.className='badge err'; });
  }
  pingGas();
  setInterval(pingGas, 45000);

  // ====== 清單渲染 ======
  function renderTable(values){
    rows.innerHTML = '';
    for (const v of values){
      const id = v[0], name = v[1], tier = v[2], rawLimit = v[3];
      const ymd = (typeof rawLimit === 'number') ? serialToYmd(rawLimit) : (rawLimit || '');
      const tr = document.createElement('tr');
      tr.dataset.id = id;
      tr.innerHTML = `<td class="col-id">${id}</td>
                      <td class="col-name">${name}</td>
                      <td class="col-tier">${tier}</td>
                      <td class="col-limit">${ymd}</td>`;
      tr.onclick = () => fillForm(id, name, tier, ymd);
      rows.appendChild(tr);
      rowById[id] = tr;
    }
  }

  function appendOrReplaceBottom(p){
    const old = rowById[p.id];
    if (old) old.remove();
    const tr = document.createElement('tr');
    tr.dataset.id = p.id;
    tr.innerHTML = `<td class="col-id">${p.id}</td>
                    <td class="col-name">${p.name}</td>
                    <td class="col-tier">${p.tier}</td>
                    <td class="col-limit">${p.ymd || ''}</td>`;
    tr.onclick = () => fillForm(p.id, p.name, p.tier, p.ymd || '');
    rows.appendChild(tr);
    rowById[p.id] = tr;
  }

  // ====== 輸入帶入 ======
  const idEl = document.getElementById('id');
  const nameEl = document.getElementById('name');
  const tierEl = document.getElementById('tier');
  const limitEl = document.getElementById('limit');
  function fillForm(id, name, tier, ymd){
    idEl.value = id || '';
    nameEl.value = name || '';
    tierEl.value = String(tier ?? 3);
    limitEl.value = ''; // ymd 無法回推 limit，交給使用者輸入
    document.querySelector('.bottom').scrollIntoView({ behavior:'smooth', block:'nearest' });
  }

  // ====== 讀取 ======
  function reloadData(){
    showMask();
    const params = new URLSearchParams();
    params.append('action','list_recent2');
    fetch(GAS_URL, { method:'POST', body:params })
      .then(r=>r.json())
      .then(d=>{
        if (d.status === 'ok') renderTable(d.values || []);
      })
      .catch(console.error)
      .finally(hideMask);
  }

  // ====== 上傳（單筆） ======
  function uploadOne(){
    const p = {
      id: (idEl.value || '').trim().toUpperCase(),
      name: (nameEl.value || '').trim(),
      tier: parseInt(tierEl.value, 10),
      limit: (limitEl.value || '').trim()
    };
    if (!/^[A-Z0-9]{5}$/.test(p.id)) { alert('ID 需為 5 碼英數大寫'); return; }
    if (!p.name) { alert('姓名不得為空'); return; }
    if (Number.isNaN(p.tier) || p.tier < 0 || p.tier > 5) { alert('級距需 0–5'); return; }
    if (p.limit !== '' && !/^\d+$/.test(p.limit)) { alert('limit 僅允許純數字'); return; }

    // limit → 序號（僅當有值）
    let limitSerial = '';
    let ymdShow = '';
    if (p.limit !== '') {
      const m = nowTPE.getUTCHours() * 60 + nowTPE.getUTCMinutes();
      const baseDate = new Date(nowTPE);
      if (m < 500) baseDate.setUTCDate(baseDate.getUTCDate() - 1);
      const baseSerial = baseSerialFromTPE(baseDate);
      limitSerial = baseSerial + Number(p.limit);
      ymdShow = serialToYmd(limitSerial);
    }

    showMask();
    const form = new URLSearchParams();
    form.append('action','upsert');
    form.append('id', p.id);
    form.append('name', p.name);
    form.append('tier', String(p.tier));
    form.append('limit_date', String(limitSerial)); // 空字串或數字字串

    fetch(GAS_URL, { method:'POST', body: form })
      .then(r=>r.json())
      .then(resp=>{
        if (resp.status === 'ok') {
          appendOrReplaceBottom({ id:p.id, name:p.name, tier:p.tier, ymd: ymdShow });
          uploadCount++;
          if (uploadCount >= 10) { uploadCount = 0; reloadData(); }
          idEl.value=''; nameEl.value=''; tierEl.value='3'; limitEl.value='';
        } else {
          alert(resp.msg || '上傳失敗');
        }
      })
      .catch(e=>{ console.error(e); alert('上傳錯誤'); })
      .finally(hideMask);
  }

  // ====== 捲動還原（行動裝置） ======
  let prevScrollY = 0;
  document.addEventListener('focusin', () => { prevScrollY = window.scrollY; }, { capture:true });
  document.addEventListener('focusout', () => {
    setTimeout(() => { window.scrollTo({ top: prevScrollY, behavior:'smooth' }); }, 50);
  }, { capture:true });

  // ====== 綁定 ======
  document.getElementById('btnReload').addEventListener('click', reloadData);
  document.getElementById('btnUpload').addEventListener('click', uploadOne);
  idEl.addEventListener('input', () => { idEl.value = idEl.value.toUpperCase().replace(/[^A-Z0-9]/g,''); });
  limitEl.addEventListener('input', () => { limitEl.value = limitEl.value.replace(/[^\d]/g,''); });

  // 初始載入
  window.addEventListener('load', reloadData);
</script>
</body>
</html>